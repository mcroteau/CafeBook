<!DOCTYPE html>
<html>
<head>
	
	<title>A Simple J2ee Project : Cafe</title>

	<meta name="description" content="">

	<meta name=”viewport” content=”width=device-width, initial-scale=1″>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	
<!--	<link href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i&display=swap" rel="stylesheet">-->

	<link href="images/" rel="icon" type="image/png" />

	<script async defer src="https://buttons.github.io/buttons.js"></script>

	<link rel="stylesheet" href="css/bootstrap.css">

	<style type="text/css">
		html,body,
		div, span, p, blockquote,
		h1, h2, h3, h4{
			color:#333333;
			color:#19191B;
			font-family:'Roboto';
            font-family: 'Arial'
		}
		h1{
			font-weight:900;
			font-size:102px !important;
			text-align: left;
		}
		h2{
			font-size:73px;
			text-align: left;
			margin-top:70px;
			font-weight:900;
			line-height: 1.7em;
		}
		h3{
			font-size:39px;
			font-weight:900;
			text-align: left;
			margin:40px auto 10px;
		}
		#logo{
			margin-top:72px;
		}
		#title{
			font-size:27px;
			display:block;
			text-align: center;
			padding:0px !important;
			margin:30px 0px 3px 0px !important;
		}
		#cover{
			width:64% !important;
			margin-left:20px !important;
			float:left
		}
		#subtitle{
			font-size:21px;
			display:block;
			text-align: center;
			margin:0px 0px 27px 0px;
		}
		#subtitle-dos{
			font-size:39px;
			display:block;
			text-align: center;
			margin:0px 0px 27px 0px;
		}
		h1#and-if{
			font-size:172px !important;
			line-height:1.4em !important;
		}
		#content{
			/**width:652px;**/
			margin:0px auto 400px auto !important;
			font-family:arial;
			font-size:27px !important;
			line-height:1.82em !important;
			text-align:left;
		}
		#like-share{
			text-align: center;
			margin:0px !important;
		}
		#challenge{
			margin-top:172px;
			display:block;
		}
		#africa-container{
			padding:0px;
			height:352px;
			margin:30px auto 89px auto !important;
		}
		#africa{
			margin:0px 0px 0px 0px;
		}
		.fb-like{
			margin-bottom:12px;
		}
		p{
			text-align: left;
			margin:20px 0px !important;
		}
		.emphasis{
			font-size:1.7em;
			line-height:2.3em;
		}
		.space-it{
			margin-top:102px !important;
		}
		.big{
			font-size:2.3em;
		}

		.minor{
			font-size:.52em;
		}

		.bold{
			font-weight:bold;
		}

		img{
			margin:auto;
		}
		img.left{
			margin:0px !important;
		}
		blockquote{
			color:#777;
			margin-top:300px;
		}
		.github-button{
			margin-bottom:30px;
			position:relative;
			display:inline-block;
			padding-bottom:30px;
		}
		.large{
			font-size:67px;
		}
		.italic{
			font-style:italic;
		}
		.center{
			text-align: center;
		}

		#buy-the-book{
			display:block;
			z-index:10001;
			position: fixed;
  			transform: rotate(45deg); /* Equal to rotateZ(45deg) */
			top:60px;
			right:-400px;
			height:40px;
			width:1000px;
			color:#fff;
			font-size:23px;
			padding-top:3px;
			font-family: Georgia;
			text-align: center;
			background:#323232;
			-webkit-box-shadow: 0px 0px 26px 0px rgba(163,160,163,1);
			-moz-box-shadow: 0px 0px 26px 0px rgba(163,160,163,1);
			box-shadow: 0px 0px 26px 0px rgba(163,160,163,1);
			-webkit-animation-name: logo-logo; /* Safari 4.0 - 8.0 */
		    -webkit-animation-duration: 4s; /* Safari 4.0 - 8.0 */
		    animation-name: logo-logo;
		    animation-iteration-count: infinite;
		    animation-duration: 73s;
			text-decoration: none;    
		}

		/* Safari 4.0 - 8.0 */
		@-webkit-keyframes logo-logo {
		  0%  {background: #323232;}
		  43%  {background: #E34B86;}
		  81% {background: #12ADFD;}
		  100% {background: #323232;}
		}

		@keyframes logo-logo {
		  0%  {background: #323232;}
		  43%  {background: #E34B86;}
		  81% {background: #12ADFD;}
		  100% {background: #323232;}
		}

		span em{
			font-family:Georgia;
			font-style:normal;
		}

		#player{
			margin-top:10px;
		}
	</style>
</head>

<body>

	<!--<a href="https://www.amazon.com/dp/0359620736" id="buy-the-book"><img src="images/buy-the-book.png"/></a>-->

	<a href="https://www.amazon.com/dp/0359620736" id="buy-the-book">Buy the Book!</a>

	<div id="content" class="container">

		<div class="col-md-2">&nbsp;</div>


		<div class="col-md-7">

			<h1 id="title">Cafe</h1>

			<h2 id="subtitle">A Simple J2ee Project</h2>
			<h3 id="subtitle-dos">Java Web Application Sample</h3>

            <p>Project source can always be found at:
                <a href="https://github.com/mcroteau/Cafe">https://github.com/mcroteau/Cafe</a></p>


			<p>This will walk you through step by step and we will create
				a simple blog application running locally on your development
				machine running <strong> h2</strong> and <strong>Jetty</strong>.
				We will not dive too far into details, rather give you a 10,000
				foot view of <strong>J2ee</strong> architecture.</p>
			
			<h3>What is J2ee</h3>

			<p><strong>J2ee</strong> is short for <strong>Java Web Application
				Development</strong>. It is enterprise ready! It is modular,
				secular and beautiful! We hope you enjoy it as much as we do.
				Without further adoo, let's go further... and build our Cafe</p>

			<p>We hope you are either running Linux, Windows with GitBash or Mac.</p>

			<img src="images/cafe.jpg" style="width:100%" class="left"/>

			<h2>First things first...</h2>

			<p>We need to install <strong>OpenJdk</strong> which will be our
				Java binary distribution and <strong>Maven</strong> our build tool.
				Installing simply means downloading the binaries and adding them to
				your system path. Here is how it is done.</p>

			<p>Browse to <a href="https://adoptopenjdk.net" target="_blank">https://adoptopenjdk.net</a>
				 and select a OpenJdk to download. Download &amp; unpack... </p>

			<p>Next we need to download Maven. Maven is our build tool, it will find &amp;
				download project dependencies for us and compile the project when
				deploying or running locally. Download then open up your <strong>.bashrc</strong>
				it is located in the home directory, if it's not there you will need to create
				it. <strong>~/</strong> means root or home directory.
				Open up a command prompt and type on a mac:</p>

			<pre>open ~/.bashrc</pre>

			<p>Our final <strong>.bashrc</strong> should look something like:</p>

			<pre>
#!/bin/bash

export JAVA_HOME=/Library/Java/JavaVirtualMachines/adoptopenjdk-8-openj9.jdk/Contents/Home
export PATH=$PATH:$JAVA_HOME/bin

export MAVEN_HOME=/Users/mcroteau/Development/Tools/apache-maven-3.6.3
export PATH=$PATH:$MAVEN_HOME/bin</pre>

			<p>Now lets "Source" which means execute our <strong>.bashrc</strong>
			so that java commands and maven commands are available! In the same
				command prompt type:</p>

			<pre>source ~/.bashrc</pre>

			<p>We will be working within the same command prompt for most of the time.
			We will need to open up another terminal/command prompt in the future
				in addition to this one.</p>

			<p>We should now be able to type <strong>java</strong>
				and <strong>mvn</strong> commands!</p>

			<pre>java -version</pre>

			<p>Should output something like the following</p>

			<pre>openjdk version "1.8.0_265"
OpenJDK Runtime Environment (build 1.8.0_265-b01)
Eclipse OpenJ9 VM (build openj9-0.21.0, JRE 1.8.0 Mac OS X amd64-64-Bit Compressed References 20200728_646 (JIT enabled, AOT enabled)
OpenJ9   - 34cf4c075
OMR      - 113e54219
JCL      - c82ff0c20f based on jdk8u265-b01)</pre>

			<p>Do the same for Maven, type:</p>

			<pre>mvn --version</pre>

			<p>It should output something like:</p>

			<pre>
Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)
Maven home: /Users/mcroteau/Development/Tools/maven-current
Java version: 1.8.0_265, vendor: Eclipse OpenJ9, runtime: /Library/Java/JavaVirtualMachines/adoptopenjdk-8-openj9.jdk/Contents/Home/jre
Default locale: en_US, platform encoding: UTF-8
OS name: "mac os x", version: "10.11.6", arch: "x86_64", family: "mac"
			</pre>

			<p><strong>Congratulations!</strong> You are on your way... let's get started.</p>


			<h3>Project Structure</h3>

			<p>We need to create our project. Create all of the following
			directories so that it looks like:</p>

<pre>
Cafe/
Cafe/src/main/java/xyz/cafe/access
Cafe/src/main/java/xyz/cafe/common
Cafe/src/main/java/xyz/cafe/dao
Cafe/src/main/java/xyz/cafe/model
Cafe/src/main/java/xyz/cafe/startup
Cafe/src/main/java/xyz/cafe/web/post
Cafe/src/main/webapp/jsp/layouts
Cafe/src/main/webapp/jsp/post
Cafe/src/main/WEB-INF</pre>


			<p>The directories or folders above are for
				supporting <strong>Servlets</strong>,
				<strong>Data Access Objects</strong>
				and <strong>Models</strong>.</p>

			<p>Please make sure all folders/directories are created.</p>

			<p>If you are developer then you are probably familiar with this
			project setup. If not, this is the cleanest most awesome way to configure
			your project. The pattern is called MVC which stands for Model View Controller.
			We have the <strong>web</strong> folder for controllers/servlets,
				the <strong>model</strong> folder for our models, and our
				<strong>jsp</strong> folder for our views.</p>


            <h3>Do you have an IDE already?</h3>

            <p><strong>What is an IDE?</strong> An IDE is an Integrated
                Development Environment, basically a tool to use in order to develop.
                Often times developers will use plain text editors, this will work fine
                but you will not have package or directory management, code assist and a lot
                fun features that a full fledged IDE has. We recommend either Eclipse or
                during this tutorial, I am using IntelliJ.
                <a href="https://www.jetbrains.com/idea/download/">https://www.jetbrains.com/idea/</a>
                They have a community addition, which is Free.
            </p>

            <a href="https://www.jetbrains.com/idea/download/"><img src="images/intellij-web.png" style="width:100%"/>
            </a>

            <p>Hold off before importing the project until you've
                created what is called <strong>pom.xml</strong>. The reason we
            are holding off until importing into our new IDE is because the IDE
            will configure the project within using the <strong>pom.xml</strong></p>

			<p>Use a simple text editor for this and
                create a file within the <strong>root Cafe</strong> directory,
                name it <strong>pom.xml</strong>. The <strong>pom.xml</strong> will
			be our main project configuration file. We will list our project
			dependencies within it. We will also configure a build &amp; run plugin
			to test our project.</p>

			<p>We are going to start from scratch so paste the following into that
				new pom.xml file:</p>
<pre>
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
	xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
	xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;xyz.cafe&lt;/groupId&gt;
    &lt;artifactId&gt;cafe&lt;/artifactId&gt;
    &lt;version&gt;0.1&lt;/version&gt;
    &lt;packaging&gt;war&lt;/packaging&gt;

    &lt;dependencies&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;jstl&lt;/groupId&gt;
            &lt;artifactId&gt;jstl&lt;/artifactId&gt;
            &lt;version&gt;1.2&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;javax.servlet&lt;/groupId&gt;
            &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;
            &lt;version&gt;4.0.1&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.h2database&lt;/groupId&gt;
            &lt;artifactId&gt;h2&lt;/artifactId&gt;
            &lt;version&gt;1.4.200&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;opensymphony&lt;/groupId&gt;
            &lt;artifactId&gt;sitemesh&lt;/artifactId&gt;
            &lt;version&gt;2.4.2&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;io.github.mcroteau&lt;/groupId&gt;
            &lt;artifactId&gt;parakeet&lt;/artifactId&gt;
            &lt;version&gt;0.2&lt;/version&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;

    &lt;build&gt;

        &lt;defaultGoal&gt;package&lt;/defaultGoal&gt;

        &lt;directory&gt;output&lt;/directory&gt;
        &lt;outputDirectory&gt;output/classes&lt;/outputDirectory&gt;

        &lt;finalName&gt;${project.artifactId}-${project.version}&lt;/finalName&gt;
        &lt;sourceDirectory&gt;src/main/java&lt;/sourceDirectory&gt;

        &lt;plugins&gt;

            &lt;plugin&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;version&gt;3.5.1&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;source&gt;1.8&lt;/source&gt;
                    &lt;target&gt;1.8&lt;/target&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;

            &lt;plugin&gt;
                &lt;groupId&gt;org.eclipse.jetty&lt;/groupId&gt;
                &lt;artifactId&gt;jetty-maven-plugin&lt;/artifactId&gt;
                &lt;version&gt;9.4.20.v20190813&lt;/version&gt;

                &lt;configuration&gt;
                    &lt;webApp&gt;
                        &lt;contextPath&gt;/cafe&lt;/contextPath&gt;
                    &lt;/webApp&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;

        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;
</pre>

			<p>What we've done above is configured and told Maven
				to look for all the dependencies within the <strong>&lt;dependencies/&gt;</strong>
				element, where to look for our Java source files, what version of Java
				to compile under and configured the project to use <strong>Jetty</strong>
				to run it in development mode.</p>

            <p>Now lets import the project into our IDE. In this example we will use
            IntelliJ. Open IntelliJ and click <strong>Open or Import</strong>. Locate
            the <strong>pom.xml</strong> and double click the file. This will bring up
            prompt asking whether or not you want to <strong>Open as Project</strong>. Click
            <strong>Open as Project</strong>. IntelliJ will import the project for you. </p>

            <img src="images/intellij-import.png" style="width:100%;"/>

			<p>Now let's configure the project as a Web project by adding a
			<strong>web.xml</strong>. Copy and paste the following:</p>
			<pre>
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee
                             http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot; version=&quot;3.1&quot;&gt;
    &lt;servlet&gt;
        &lt;servlet-name&gt;CreateServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;xyz.cafe.web.post.CreateServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;CreateServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/create&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;listener&gt;
        &lt;listener-class&gt;
            xyz.cafe.startup.AppStartup
        &lt;/listener-class&gt;
    &lt;/listener&gt;

&lt;/web-app&gt;
			</pre>

            <p>Copy and paste above into the file:</p>

            <pre>src/main/webapp/WEB-INF/<strong>web.xml</strong></pre></p>


            <p>Okay, so what have we done here? We have configured our
            project to look for what are called servlets, filters, listeners and
                more. This <strong>web.xml</strong> is pretty much empty but we will
                populate it with lots of stuff later on.</p>

            <p><strong>What is a Servlet?</strong> A servlet is a Java class that
                represents a web route.
            A request gets passed to this route that is defined as you saw above. Here is
            an example.. there are plenty above but let's pick one out and go into detail.</p>

            <p>The standard for defining a Servlet, and we defined our first above:</p>
            <pre>
&lt;servlet&gt;
    &lt;servlet-name&gt;CreateServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;xyz.cafe.web.post.CreateServlet&lt;/servlet-class&gt;
&lt;/servlet&gt;

&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;CreateServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/create&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
            </pre>

            <p>So we defined here in our project a Servlet that we named
            <strong>CreateServlet</strong> it will be located in the folder
            <pre>src/main/java/xyz/cafe/web/post</pre> The request will get
                passed to <strong>/create</strong> like below:</p>

            <pre>http://localhost:8080/cafe/<strong>create</strong></pre>

            <p><strong>What is a request?</strong> A request is a web request.
            Anytime you type in a browser bar and hit enter, that is called
            a <strong>Request</strong>.</p>

            <p>We defined for the blog post the following:</p>

            <ul>
                <li><strong>ListServlet</strong> : which will list the blog posts</li>
                <li><strong>CreateServlet</strong> : displays a create blog post</li>
                <li><strong>SaveServlet</strong> : saves a post</li>
                <li><strong>UpdateServlet</strong> : allows us to update a post</li>
                <li><strong>EditServlet</strong> : allowing us to edit our post</li>
                <li><strong>DeleteServlet</strong> : to delete a post</li>
            </ul>

            <h3>Great! But...</h3>

            <p>We have no Servlets created and we haven't even
                run our project yet! Okay, let's create one and also while
                we are at it create the Java class that will be waiting for the
                project to start up. </p>

            <p>Take another look at the <strong>web.xml</strong>. Track down
            the following.</p>

            <pre>
&lt;listener&gt;
    &lt;listener-class&gt;
        xyz.cafe.startup.AppStartup
    &lt;/listener-class&gt;
&lt;/listener&gt;
            </pre>

            <p>Within your <strong>web.xml</strong> you can define what are called
            application listeners. In this case we are defining a class that will
            listen for the startup event... thus the name AppStartup. So let's
            create that class.</p>

            <pre>src/main/java/xyz/cafe/startup/<strong>AppStartup.java</strong></pre>

            <p>Copy and paste the following into that file. We will be updating it
            with more logic later on, but this will get us started.</p>

            <pre>
package xyz.cafe.startup;

import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;

public class AppStartup implements ServletContextListener {

    @Override
    public void contextInitialized(ServletContextEvent sce) {
        //application startup
    }

    @Override
    public void contextDestroyed(ServletContextEvent sce) {
        //application shutdown
    }

}
            </pre>

            <p>Now let's try something... let's run our project and see what happens.
            Just in case, this is what your project should look like at this point: </p>

            <img src="images/project-start.png" style="width:100%"/>

            <p>Let's start with
                the CreateServlet so we can run our newly created project and
                actually see something... geez.</p>

            <p>Back to your IDE, in the directory</p>
                <pre>src/main/java/xyz/cafe/post/</pre>

            <p>create a Java
                class by right clicking on the <strong>post</strong> directory
            and selecting <strong>New -> Java Class</strong>. Or just create a new
            file and name it <strong>CreateServlet.java</strong></p>

            <pre>/src/main/java/xyz/cafe/post/<strong>CreateServlet.java</strong></pre>

            <p>Copy and the code below into your new Java class.</p>

            <pre>
package xyz.cafe.web.post;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class CreateServlet extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        req.getRequestDispatcher("/jsp/post/create.jsp").forward(req, resp);
    }
}
            </pre>


            <p>Notice the CreateServlet extends HttpServlet... this means that all the methods
            that are within <strong>HttpServlet</strong> are overrideable. There are three
            very important methods that you will at some point in time override if writing
            a J2ee application. <strong>doGet()</strong> <strong>doPost()</strong>
            and <strong>init()</strong></p>

            <p>Here we override <strong>doGet()</strong></p>

            <p>There is another important piece, notice the forward at the end,
                without the <strong>.forward(req, resp)</strong> you will see a
            blank screen.</p>
            <pre>
req.getRequestDispatcher("/jsp/post/create.jsp").forward(req, resp);
            </pre>

            <p>So we have out first servlet, and it overrides a
            <strong>doGet()</strong> verb which means nothing is hidden,
            you can simply type in the servlet path, hit enter and browse to the
            servlet. We don't have a <strong>create.jsp</strong> yet.
            Let's create that. Create the <strong>create.jsp</strong> at:</p>

            <pre>src/main/webapp/jsp/post/<strong>create.jsp</strong></pre>

            <p>Copy and past the following code within the <strong>create.jsp</strong>.</p>


            <pre>
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Cafe : Create Post&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Create Post&lt;/h1&gt;

&lt;c:if test=&quot;${not empty message}&quot;&gt;
    &lt;p&gt;&lt;c:out value=&quot;${message}&quot;/&gt;&lt;/p&gt;
&lt;/c:if&gt;

&lt;form action=&quot;${pageContext.request.contextPath}/save&quot; method=&quot;post&quot;&gt;

    &lt;label&gt;Title&lt;/label&gt;
    &lt;input type=&quot;text&quot; name=&quot;title&quot; placeholder=&quot;title&quot;/&gt;

    &lt;br/&gt;

    &lt;label&gt;Content&lt;/label&gt;
    &lt;textarea name=&quot;content&quot;&gt;&lt;/textarea&gt;

    &lt;br/&gt;
    &lt;br/&gt;

    &lt;input type=&quot;submit&quot; value=&quot;Save!&quot;/&gt;
&lt;/form&gt;

&lt;/body&gt;
&lt;/html&gt;
            </pre>


            <strong>What is a Jsp?</strong> Jsp stands for Java Server Page.
            It is the view in our Model, View, Controller setup.</p>

            <p>Okay! We now have the basics for a Java web app. Let's run it!</p>

            <p>Back to the terminal or command prompt. Make sure you're in the main
            <strong>Cafe</strong> directory. Type:</p>

            <pre>mvn jetty:run</pre>

            <p>You will see a bunch of output, this is logging. We won't go into that
            but if you want to learn more about logging checkout <strong>slf4j</strong></p>

            <p>So what did we do? We told Maven to compile the project and told
            <strong>Jetty</strong> to run it. Now open up a web browser and go to:</p>

            <pre>http://localhost:8080/cafe</pre>

            <p>You should see the following.</p>

            <img src="images/app-base.png" style="width:100%"/>

            <p>This is our start. We might not like this as our start obviously because
            this shows the basic standard packages but its not really what we are looking for
            with our blog application. We will change this soon. Go ahead now and lets
            browse to our first servlet, the <strong>CreateServlet</strong> at
            <strong>/create</strong></p>

            <pre>http://localhost:8080/cafe/create</pre>

            <p>You should see something like the following:</p>

            <img src="images/create-jsp.png" style="width:100%;"/>

            <p>Now, we have our very first request pointing to our first servlet
                located <strong>/create</strong>. But it looks ugly, have no fear,
            by the end of this tutorial, our blog application will be so slick!</p>

            <p>So we can view a create blog post page, so what... we need to be able to
            <strong>save, edit, update and delete</strong> our blog posts. Before
            we do that, let's think about security and data.</p>

            <p>First off, not everyone should be able to create a blog post! Second,
                where and how are we going to store the blog post data?
                What does a blog post look like? Etc.</p>

            <p>Let's start with data, introducing <strong>h2</strong>.
            <strong>h2</strong> is an in memory data store. This will work perfect
            while we are developing. You might have noticed it already, but we have
            the dependency already defined in our <strong>pom.xml</strong>. </p>

            <pre>
&lt;dependency&gt;
    &lt;groupId&gt;com.h2database&lt;/groupId&gt;
    &lt;artifactId&gt;h2&lt;/artifactId&gt;
    &lt;version&gt;1.4.200&lt;/version&gt;
&lt;/dependency&gt;
            </pre>

            <p>So the library is there but we need to run it. Lets create
                a new top level directory under:</p>

            <pre>Cafe/exec/</pre>


            <p>When maven fetches dependencies, it stores them under a directory
            located in your home directory called <strong>.m2/</strong>. Copy the
                <strong>h2-1.4.200.jar</strong> into the new <strong>exec/</strong>
            directory.</p>

            <pre>cp ~/.m2/repository/com/h2database/h2/1.4.200/h2-1.4.200.jar exec/</pre>

            <p>We now have our <strong>h2-1.4.200</strong> jar. We are going to hold off
            running it until we have our tables setup. We also can configure h2
            to execute startup and shutdown sql scripts which is what we are going to do.</p>

            <p>Let's define our tables</p>

            <p>Our tables will include <strong>accounts, posts, roles, account_roles
                &amp; account_permissions</strong> for our application.
                So let's create a file called <strong>create-db.sql</strong>
                under the new <strong>exec/</strong> directory.</p>

            <pre>Cafe/exec/<strong>create-db.sql</strong></pre>

            <p>Paste the following into our new file.</p>

            <pre>
create table accounts (
	id bigint PRIMARY KEY AUTO_INCREMENT,
	name character varying(55),
	username character varying(55) NOT NULL,
	password character varying(155) NOT NULL
);

create table roles (
	id bigint PRIMARY KEY AUTO_INCREMENT,
	name character varying(55) NOT NULL UNIQUE
);

create table user_roles (
	role_id bigint NOT NULL REFERENCES roles(id),
	account_id bigint NOT NULL REFERENCES accounts(id)
);

create table user_permissions (
	account_id bigint REFERENCES accounts(id),
	permission character varying(55)
);

create table posts (
	id bigint PRIMARY KEY AUTO_INCREMENT,
	account_id bigint NOT NULL REFERENCES accounts(id),
	title character varying(172),
	content text,
	date_created bigint NOT NULL
);

insert into accounts values (1, 'owner', 'owner@mail.co', '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8');
insert into accounts values (2, 'barista', 'barista@mail.co', '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8');

insert into roles values (1, 'ROLE_OWNER');
insert into roles values (2, 'ROLE_BARISTA');

insert into user_roles values (1, 1);
insert into user_roles values (2, 2);
            </pre>

            <p>What we have done here is defined our tables for our database and
            inserted some base user authorization information. There are 2 roles,
            one for the owners and the other for baristas. Both should be able to
            create blog posts, only the person who created the post or the owner
            should be able to edit a post and finally only the owner should be able
            to delete a post. Most of this logic for this will reside in our code.</p>

            <p>The <strong>create-db.sql</strong> should get executed on startup,
            so let's do that.</p>

            <p>Now we need a script file for our shutdown operations. This script
            will simply drop all the tables so that when we restart our application we
            don't have to manually stop <strong>h2</strong> and delete our database
                on restart.</p>

            <p>Let's create the script to drop the tables on shutdown. Create:</p>

            <pre>exec/<strong>drop-db.sql</strong></pre>

            <p>Past the following into that sql script file.</p>

            <pre>
drop table posts;
drop table user_roles;
drop table user_permissions;
drop table accounts;
drop table roles;
            </pre>

            <p>In order to run the scripts on our startup and shutdown routines,
                we need to be able to connect to the database. So let's create our connection.</p>

            <p>First let's create a constants file to hold all of our global constant
            variables including those for our db connection.
                Create a Constants.java Java class in:</p>

            <pre>src/main/java/xyz/cafe/common/<strong>Constants.java</strong></pre>

            <p>Paste the following code into the <strong>Constants.java</strong> class</p>

            <pre>
package xyz.cafe.common;

public class Constants {

    public static final String USER = "sa";
    public static final String PASS = "";

    public static final String URL  = "jdbc:h2:tcp://localhost:9092/" +
            "~/Development/Projects/Cafe/exec/cafe";

    public static final String PARAKEET_LOOKUP  = "Parakeet";
    public static final String USER_DAO_LOOKUP  = "UserDao";
    public static final String POSTS_DAO_LOOKUP = "PostsDao";
    public static final String DATE_FORMAT  = "yyyyMMddHHmmssSSS";

    public static final String ROLE_OWNER  = "ROLE_OWNER";
    public static final String POST_PREFIX = "post:maintenance:";

}
            </pre>

            <p>One major constant that needs to be reviewed is the
                <strong>URL</strong>. My Cafe project is located at:</p>

            <pre>~/Development/projects/Cafe/</pre>

            <p>You will have to change this to match where your project
                is located. If it is on your  desktop, then URL would probably
                look like:</p>

            <pre>
jdbc:h2:tcp://localhost:9092/~/Desktop/Cafe/exec/cafe;
</pre>
            <p>This will be the url of our database connection.
                <strong>h2</strong> will create an in memory database
                in that location.</p>

            <p>Now let's create a <strong>Utils.java</strong> class to hold
            all of our utility methods like getting the current date in a nice
            and neat format, date conversions and a hashing password.
            Create a new <strong>Utils.java</strong> class located at:</p>

            <pre>src/main/java/xyz/common/<strong>Utils.java</strong></pre>

            <p>Copy & paste the following code into it.</p>

            <pre>
package xyz.cafe.common;

import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;

public class Utils {

    public static String hash(String password){
        MessageDigest md = null;
        StringBuffer passwordHashed = new StringBuffer();

        try {
            md = MessageDigest.getInstance("SHA-256");
            md.update(password.getBytes());

            byte byteData[] = md.digest();

            for (int i = 0; i < byteData.length; i++) {
                passwordHashed.append(Integer.toString((byteData[i] & 0xff) + 0x100, 16).substring(1));
            }

        } catch (NoSuchAlgorithmException e) {
            e.printStackTrace();
        }
        return passwordHashed.toString();
    }

    public static String getDate(long dateLong) {
        try {
            Calendar cal = Calendar.getInstance();
            SimpleDateFormat sdf = new SimpleDateFormat(Constants.DATE_FORMAT);

            String dateString = String.valueOf(dateLong);
            Date parsedDate = sdf.parse(dateString);

            cal.setTime(parsedDate);
            Date date = cal.getTime();

            return date.toString();

        }catch(Exception ex){
            ex.printStackTrace();
        }
        return null;
    }

    public static long getDate() {
        Calendar cal = Calendar.getInstance();
        long date = getDateFormatted(cal);
        return date;
    }

    private static long getDateFormatted(Calendar cal) {
        DateFormat df = new SimpleDateFormat(Constants.DATE_FORMAT);
        String dateStr = df.format(cal.getTime());
        long date = Long.parseLong(dateStr);
        return date;
    }
}
            </pre>

            <p>Okay, this is going to get into the weeds a little moving onward...
                Now we need to create a DbConnection.java Java class located at:</p>

            <pre>src/main/java/xyz/cafe/factory/<strong>DbConnection.java</strong></pre>

            <p>Paste the following code within it:</p>

            <pre>
package xyz.cafe.factory;

import xyz.cafe.common.Constants;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;

public class DbFactory {

    public static Connection getConnection() {
        try {
            Class.forName("org.h2.Driver");
            return DriverManager.getConnection(Constants.URL, Constants.USER, Constants.PASS);
        } catch (SQLException | ClassNotFoundException ex) {
            throw new RuntimeException("Error connecting to the database", ex);
        }
    }

}
            </pre>


            <p>This class will return a h2 database connection.</p>

            <p>Now, back to the <strong>AppStartup</strong> Java class.</p>

            <pre>src/main/java/xyz/cafe/startup/<strong>AppStartup.java</strong></pre>

            <p>Edit it so it looks like this:</p>

            <pre>
package xyz.cafe.startup;

import org.h2.tools.RunScript;
import xyz.cafe.factory.DbFactory;

import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;
import java.io.FileReader;
import java.sql.Connection;

public class AppStartup implements ServletContextListener {

    @Override
    public void contextInitialized(ServletContextEvent sce) {
        try {

            System.out.println("Starting up!");
            Connection conn = DbFactory.getConnection();
            RunScript.execute(conn, new FileReader("exec/create-db.sql"));

        }catch(Exception ex){
            ex.printStackTrace();
        }
    }

    @Override
    public void contextDestroyed(ServletContextEvent sce) {
        try {

            Connection conn = DbFactory.getConnection();
            RunScript.execute(conn, new FileReader("exec/drop-db.sql"));

        }catch(Exception ex){
            ex.printStackTrace();
        }
    }

}
            </pre>

            <p>We will be coming back to this class one more time to fill it up
                with some neat stuff!</p>

            <p>Let's test our project again, now before we run our maven
                command to start the project, we need to start h2. Let's do
            that. Run the following command while in the Cafe directory.</p>

            <pre>java -jar exec/h2-1.4.200.jar</pre>

            <p>You should see a Java icon the bottom of your screen and
            a browser window should popup and show you the connection screen
            for h2. </p>

            <img src="images/h2-connect.png" style="width:100%"/>

            <p>You will need to change the <strong>JDBC URL</strong> to match the
                location of the Constants URL. The location for my h2 instance
                again will be at:</p>

            <pre>~/Development/Projects/Cafe/exec/cafe</pre>

            <p>So the full JDBC URL in the browser connection screen
                should read :</p>

            <pre>jdbc:h2:~/Development/Projects/Cafe/exec/cafe</pre>

            <p><strong>Now click Connect!</strong></p>

            <p>You should see a screen that looks like the following:</p>

            <img src="images/h2-connected.png" style="width:100%"/>

            <p>Wait, we have no tables! Here we could manually create our
            tables using the <strong>create-db.sql</strong> script we created
            earlier, but instead we are going to rely on the tools available
            within h2 to do this for us on startup.</p>

            <p>Let's run our project! Open up another terminal window, now you
            should have 2 terminal windows open, both opened up within the main
            Cafe directory. Run:</p>

            <pre>mvn jetty:run</pre>

            <h3>Congratulations again! Yep Again!</h3>

            <p>A milestone has been reached. Go back to the browser window with
            the h2 database connection and click the refresh button in the top
            left.</p>

            <img src="images/h2-refresh.png"/>

            <p>You should now see all of our database tables created!</p>

            <img src="images/h2-startup.png" style="width:100%"/>

            <p>Great! We are well on our way. What we have done is developed a
            routine that will allow us to stop and start the application as needed
            without having to mess with <strong>h2</strong> again. If for some
            reason your database gets out of sync, simply delete the file
            named <strong>cafe.mv.db</strong> located at:</p>

            <pre>exec/<strong>cafe.mv.db</strong></pre>

            <p>and restart the application.</p>

            <p>Okay, now let's talk about security a little. In this tutorial
            we will be using <strong>Parakeet</strong> to secure our requests.
            If you take a look at the <strong>pom.xml</strong> you'll see we have
            already defined our Parakeet dependency. Now let's use it. First we need
            to make Parakeet available through out the application so we will create
            a factory class for this. In addition we will be updating our startup
            routine to include storing of Parakeet so during a request we can gain access
            to the same instance.</p>

            <p>The <strong>ParakeetFactory.java</strong> will be put at:</p>

            <pre>src/main/java/xyz/cafe/factory/<strong>ParakeetFactory.java</strong></pre>

            <p>Copy &amp; paste the following code in the new Java class.</p>

            <pre>
package xyz.cafe.factory;

import io.github.mcroteau.Parakeet;
import io.github.mcroteau.resources.access.Accessor;
import xyz.cafe.access.JdbcAccessor;

public class ParakeetFactory {

    Parakeet parakeet;
    Accessor accessor;

    public ParakeetFactory(){
        accessor = new JdbcAccessor();
        parakeet = new Parakeet(accessor);
    }

    public Parakeet getParakeet(){
        return this.parakeet;
    }

}
            </pre>

            <p>This is a simple class with one method that will return our
            <strong>parakeet</strong> instance. We use the constructor to create
            our Parakeet instance instantiating an accessor which will return
            data to Parakeet as needed. You should see compilation errors in
            <strong>ParakeetFactory</strong> above on the JdbcAccessor.</p>

            <p>We are going to solve this error by first creating our models to
                hold our instance data, our UserDao to interact with the database.</p>

            <p>First let's create our two models for the application. One for our
            blog posts, the other for our users. This should have been one of the first
            things we should do but it's okay, we aren't too far into development yet.
            Create a <strong>User.java</strong> class at:</p>

            <pre>src/main/java/xyz/cafe/model/<strong>User.java</strong></pre>

            <p>Go ahead and copy and past the following code into it: </p>

            <pre>
package xyz.cafe.model;

public class User {

    long id;
    String name;
    String username;
    String password;

    public long getId() {
        return id;
    }

    public void setId(long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

}
            </pre>


            <p>Now let's create a <strong>Post.java</strong> model or domain
            in same location:</p>

            <pre>src/main/java/xyz/cafe/model/<strong>Post.java</strong></pre>

            <p>Copy &amp; paste the following code into it.</p>

            <pre>
package xyz.cafe.model;

public class Post {

    public long id;
    public String title;
    public String content;
    public long userId;
    public long dateCreated;
    public String date;

    public long getId() {
        return id;
    }

    public void setId(long id) {
        this.id = id;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public String getContent() {
        return content;
    }

    public long getUserId() {
        return userId;
    }

    public void setUserId(long userId) {
        this.userId = userId;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public long getDateCreated() {
        return dateCreated;
    }

    public void setDateCreated(long dateCreated) {
        this.dateCreated = dateCreated;
    }

    public String getDate() {
        return date;
    }

    public void setDate(String date) {
        this.date = date;
    }

}
            </pre>

            <p>Now we have models for our application. Every time you
            want to store something into a database using this structure
            you will want a complimentary model and dao. So we are going to
            compliment our models by creating two data access objects.
            One for users and the other for blog posts. The data access
            object will perform our save, update and delete routines and
            in addition perform any other kind of data retrieval.</p>

            <p>Let's create a <strong>UserDao.java</strong> and a
            <strong>PostDao.java</strong> like below:</p>

            <pre>src/main/java/xyz/cafe/dao/<strong>UserDao.java</strong></pre>

            <pre>src/main/java/xyz/cafe/dao/<strong>PostDao.java</strong></pre>

            <p>Copy &amp; paste the following into our <strong>UserDao.java</strong>
            class.</p>

            <pre>
package xyz.cafe.dao;

import xyz.cafe.factory.DbFactory;
import xyz.cafe.model.User;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.HashSet;
import java.util.Set;

public class UserDao {

    Connection connection;

    public UserDao(){
        connection = DbFactory.getConnection();
    }

    public User getUser(String username){
        try {
            Statement stmt = connection.createStatement();
            String sql = &quot;select * from accounts where username = '&quot; + username + &quot;'&quot;;
            ResultSet rs = stmt.executeQuery(sql);
            if(rs.next()){
                User user = new User();
                user.setId(rs.getLong(&quot;id&quot;));
                user.setName(rs.getString(&quot;name&quot;));
                user.setUsername(rs.getString(&quot;username&quot;));
                user.setPassword(rs.getString(&quot;password&quot;));
                return user;
            }

        }catch(Exception e){
            e.printStackTrace();
        }
        return null;
    }


    public String getPassword(String username){
        try {
            Statement stmt = connection.createStatement();
            String sql = &quot;select password from accounts where username = '&quot; + username + &quot;'&quot;;
            ResultSet rs = stmt.executeQuery(sql);
            if (rs.next()) {
                return rs.getString(&quot;password&quot;);
            }
        }catch(Exception e){
            e.printStackTrace();
        }
        return &quot;&quot;;
    }

    public Set&lt;String&gt; getUserRoles(String username){
        try {
            User user = getUser(username);
            Statement stmt = connection.createStatement();
            ResultSet rs = stmt.executeQuery(&quot;select r.name from user_roles ur, roles r where ur.role_id = r.id and ur.account_id = &quot; + user.getId());

            Set&lt;String&gt; roles = new HashSet&lt;String&gt;();
            while(rs.next()){
                String role = rs.getString(&quot;name&quot;);
                roles.add(role);
            }
            return roles;
        }catch(Exception e){
            e.printStackTrace();
        }
        return null;
    }

    public Set&lt;String&gt; getUserPermissions(String username){
        try {
            User user = getUser(username);
            Statement stmt = connection.createStatement();
            ResultSet rs = stmt.executeQuery(&quot;select permission from user_permissions where account_id = &quot; + user.getId());
            Set&lt;String&gt; permissions = new HashSet&lt;String&gt;();
            while(rs.next()){
                String permission = rs.getString(&quot;permission&quot;);
                permissions.add(permission);
            }
            return permissions;
        }catch(Exception e){
            e.printStackTrace();
        }
        return null;
    }

    public boolean saveUserPermission(String permission, long id){
        try {
            String sql = &quot;insert into user_permissions values ( ?, ? );&quot;;

            PreparedStatement stmt = connection.prepareStatement(sql);
            stmt.setLong(1, id);
            stmt.setString(2, permission);

            int result = stmt.executeUpdate();
            if (result == 1) return true;

        }catch(Exception ex){
            ex.printStackTrace();
        }

        return false;
    }
}

            </pre>

            <p>UserDao is done. We have methods for getting a user from the
                database, getting the password for Parakeet, retrieving user roles
                and permissions and saving a permission. Okay, what's next?
                Now let's do the same for our <strong>PostDao.java</strong>
            Copy &amp; paste the following into <strong>PostDao</strong>. </p>

            <pre>
package xyz.cafe.dao;

import xyz.cafe.factory.DbFactory;
import xyz.cafe.model.Post;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class PostDao {
    Connection connection;

    public PostDao(){
        connection = DbFactory.getConnection();
    }

    public Post getById(long id) {
        try {
            String sql = &quot;select * from posts where id = &quot; + id;
            Statement stmt = connection.createStatement();
            ResultSet rs = stmt.executeQuery(sql);

            if(rs.next()){
                Post post = extractResultSetPost(rs);
                return post;
            }

        }catch(Exception ex){
            ex.printStackTrace();
        }
        return null;
    }

    public Post getLast(){
        try {
            String sql = &quot;select * from posts order by date_created desc limit 1 &quot;;
            Statement stmt = connection.createStatement();
            ResultSet rs = stmt.executeQuery(sql);

            if(rs.next()){
                Post post = extractResultSetPost(rs);
                return post;
            }

        }catch(Exception ex){
            ex.printStackTrace();
        }
        return null;
    }

    public Post save(Post post){
        try {
            String sql = &quot;insert into posts values ( null, ?, ?, ?, ? );&quot;;

            PreparedStatement stmt = connection.prepareStatement(sql);
            stmt.setLong(1, post.getUserId());
            stmt.setString(2, post.getTitle());
            stmt.setString(3, post.getContent());
            stmt.setLong(4, post.getDateCreated());

            int result = stmt.executeUpdate();
            if(result == 1) {
                Post savedPost = getLast();
                return savedPost;
            }

        }catch(Exception ex){
            ex.printStackTrace();
        }

        return null;
    }

    public boolean update(Post post){
        try {
            String sql = &quot;update posts set title = ?, content = ? where id = &quot; + post.getId();

            PreparedStatement stmt = connection.prepareStatement(sql);
            stmt.setString(1, post.getTitle());
            stmt.setString(2, post.getContent());

            int result = stmt.executeUpdate();
            if(result == 1) {
                return true;
            }

        }catch(Exception ex){
            ex.printStackTrace();
        }

        return false;
    }


    public boolean delete(long id){
        try {
            String sql = &quot;delete from posts where id = &quot; + id;

            PreparedStatement stmt = connection.prepareStatement(sql);
            int result = stmt.executeUpdate();

            if(result == 1) {
                return true;
            }

        }catch(SQLException ex){
            ex.printStackTrace();
        }

        return false;
    }

    public List&lt;Post&gt; getList(){
        try {
            Statement stmt = connection.createStatement();
            String sql = &quot;select * from posts&quot;;
            ResultSet rs = stmt.executeQuery(sql);

            List&lt;Post&gt; posts = new ArrayList&lt;Post&gt;();
            while(rs.next()){
                Post post = extractResultSetPost(rs);
                posts.add(post);
            }

            return posts;

        }catch(Exception e){
            e.printStackTrace();
        }
        return null;
    }

    private Post extractResultSetPost(ResultSet rs) throws Exception{
        Post post = new Post();
        post.setId(rs.getLong(&quot;id&quot;));
        post.setTitle(rs.getString(&quot;title&quot;));
        post.setContent(rs.getString(&quot;content&quot;));
        post.setDateCreated(rs.getLong(&quot;date_created&quot;));
        return post;
    }

}
            </pre>

            <h3>Now we are talking!</h3>

            <p>We have created beautiful Java classes to interact with our
                <strong>h2</strong> instance or any other data source we
                configure in the future. This class will save posts,
            update posts... etc. We are now well on our way. Let's create that pesky
            JdbcAccessor for Parakeet our security module. </p>

            <p>Create a file located at:</p>

            <pre>src/main/java/xyz/cafe/access/<strong>JdbcAccessor.java</strong></pre>

            <p>Copy &amp; paste the following code within that class.</p>

            <pre>
package xyz.cafe.access;

import io.github.mcroteau.resources.access.Accessor;
import xyz.cafe.dao.UserDao;

import java.util.Set;

public class JdbcAccessor implements Accessor {

    UserDao userDao;

    public JdbcAccessor(){
        this.userDao = new UserDao();
    }

    @Override
    public String getPassword(String username) {
        return userDao.getPassword(username);
    }

    @Override
    public Set&lt;String&gt; getRoles(String username) {
        return userDao.getUserRoles(username);
    }

    @Override
    public Set&lt;String&gt; getPermissions(String username) {
        return userDao.getUserPermissions(username);
    }

}
            </pre>


            <p>Our pain in the neck error in our ParakeetFactory class should
            now be gone. We have officially installed the plumbing if you will for
            our application. But are not done. How are we going to make Parakeet
                and our Daos available through a request cycle? By using the
            ServletContext which is available to us at startup. Let's update
            our <strong>AppStartup.java</strong> class to look like :</p>

            <pre>
package xyz.cafe.startup;

import io.github.mcroteau.Parakeet;
import org.h2.tools.RunScript;
import xyz.cafe.common.Constants;
import xyz.cafe.dao.PostDao;
import xyz.cafe.dao.UserDao;
import xyz.cafe.factory.DbFactory;
import xyz.cafe.factory.ParakeetFactory;

import javax.servlet.ServletContext;
import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;
import java.io.FileReader;
import java.sql.Connection;

public class AppStartup implements ServletContextListener {

    @Override
    public void contextInitialized(ServletContextEvent sce) {
        try {

            System.out.println(&quot;Starting up!&quot;);
            PostDao postDao = new PostDao();
            UserDao userDao = new UserDao();

            ParakeetFactory parakeetFactory = new ParakeetFactory();
            Parakeet parakeet = parakeetFactory.getParakeet();

            Connection conn = DbFactory.getConnection();
            ServletContext context = sce.getServletContext();
            context.setAttribute(Constants.PARAKEET_LOOKUP, parakeet);
            context.setAttribute(Constants.POSTS_DAO_LOOKUP, postDao);
            context.setAttribute(Constants.USER_DAO_LOOKUP, userDao);

            RunScript.execute(conn, new FileReader(&quot;exec/create-db.sql&quot;));

        }catch(Exception e){
            e.printStackTrace();
        }
    }

    @Override
    public void contextDestroyed(ServletContextEvent sce) {
        try {
            System.out.println(&quot;Shutting down!&quot;);
            Connection conn = DbFactory.getConnection();
            RunScript.execute(conn, new FileReader(&quot;exec/drop-db.sql&quot;));
        }catch(Exception ex){
            ex.printStackTrace();
        }
    }

}
            </pre>

            <p>What we have done here is told our application to store our
            <strong>UserDao, PostDao and Parakeet</strong> so we can use them
            later on instead of quote unquote newing them up during a request or
            within the constructors of our application. I'll show you what I mean. </p>

            <p>Let's create a new servlet! One for Saving our blog posts. Create a new
                <strong>SaveServlet.java</strong> Java class located at:</p>

            <pre>src/main/java/xyz/cafe/web/<strong>SaveServlet.java</strong></pre>

            <p>This class will simply take a request and save the blog post
            data. Copy &amp; paste the following code into this class:</p>

            <pre>
package xyz.cafe.web.post;

import io.github.mcroteau.Parakeet;
import xyz.cafe.dao.PostDao;
import xyz.cafe.dao.UserDao;
import xyz.cafe.model.Post;
import xyz.cafe.model.User;
import xyz.cafe.common.Constants;
import xyz.cafe.common.Utils;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class SaveServlet extends HttpServlet {

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        ServletContext context = req.getServletContext();
        Parakeet parakeet = (Parakeet) context.getAttribute(Constants.PARAKEET_LOOKUP);
        PostDao postDao = (PostDao) context.getAttribute(Constants.POSTS_DAO_LOOKUP);
        UserDao userDao = (UserDao) context.getAttribute(Constants.USER_DAO_LOOKUP);

        if(parakeet.isAuthenticated()){
            User user = userDao.getUser(parakeet.getUser());
            Post post = new Post();
            String title = req.getParameter(&quot;title&quot;);
            String content = req.getParameter(&quot;content&quot;);

            post.setTitle(title);
            post.setContent(content);
            post.setDateCreated(Utils.getDate());
            post.setUserId(user.getId());

            Post savedPost = postDao.save(post);
            String permission = Constants.POST_PREFIX + savedPost.getId();
            userDao.saveUserPermission(permission, user.getId());

            req.setAttribute(&quot;message&quot;, &quot;Successfully saved post!&quot;);
            req.setAttribute(&quot;post&quot;, savedPost);
            req.getRequestDispatcher(&quot;/jsp/post/edit.jsp&quot;).forward(req, resp);
        }else{
            resp.sendRedirect(context.getContextPath() + &quot;/signin&quot;);
        }
    }
}
            </pre>

            <p>What I want you to pay attention to is the ability to get objects
            within a request! Take a look above at the code and locate the following </p>

            <pre>
ServletContext context = req.getServletContext();
Parakeet parakeet = (Parakeet) context.getAttribute(Constants.PARAKEET_LOOKUP);
PostDao postDao = (PostDao) context.getAttribute(Constants.POSTS_DAO_LOOKUP);
UserDao userDao = (UserDao) context.getAttribute(Constants.USER_DAO_LOOKUP);
            </pre>

            <p>Pretty neat eh!</p>

            <p>If you observed the <strong>SaveServlet</strong> in detail you
            will notice we redirect to a signin screen if the user isn't
            authenticated <strong>parakeet.isAuthenticated()</strong>. So let's
            create our signin routine!</p>

            <p>First run the project to make sure there are no start up errors
            and that we look good to move onto the next step. You should not need
            to run:</p>

            <pre>java -jar exec/h2-1.4.200.jar</pre>

            <p>We can simply restart our application. First to stop it within
                the terminal click command + c. Now we can start again: </p>

            <pre>mvn jetty:run</pre>

            <p>Okay! Should have got no errors. If you did, check that your database
            is not out of sync. If it is, delete the in memory data store file
            <strong>cafe.mv.db</strong> located at:</p>

            <pre>exec/<strong>cafe.mv.db</strong></pre>

            <p>and try again! All should be good!</p>

            <p>Okay! We have Parakeet module installed, we have our ParakeetFactory
            we create and store an instance of Parakeet within our application via
            the ServletContext. Now we need to add the signin/logout logic.</p>

            <p>Create the following Java classes <strong>SigninServlet.java,
            LogoutServlet.java, &amp; AuthServlet.java</strong> located at:</p>

            <pre>
src/main/java/xyz/cafe/web/<strong>SigninServlet.java</strong>
src/main/java/xyz/cafe/web/<strong>LogoutServlet.java</strong>
src/main/java/xyz/cafe/web/<strong>AuthServlet.java</strong>
            </pre>

            <p>First let's start with:</p>

            <pre>src/main/java/xyz/cafe/web/<strong>SigninServlet.java</strong></pre>

            <p>Copy &amp; paste the following code into the SinginServlet.java
            class:</p>

            <pre>
package xyz.cafe.web;

import io.github.mcroteau.Parakeet;
import xyz.cafe.common.Constants;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class SigninServlet extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        ServletContext context = req.getServletContext();
        Parakeet parakeet = (Parakeet) context.getAttribute(Constants.PARAKEET_LOOKUP);

        if(!parakeet.isAuthenticated()) {
            req.getRequestDispatcher("/jsp/signin.jsp").forward(req, resp);
        }else{
            resp.sendRedirect(req.getContextPath() + "/");
        }
    }

}
            </pre>


            <p>Here we get the instance of Parakeet, check if the current user is
            authenticated if not, display a signin screen, if they are
                authenticated redirect them to "/".</p>

            <p>Let's add the SigninServlet to our <strong>web.xml</strong></p>

            <pre>
    &lt;servlet&gt;
        &lt;servlet-name&gt;SigninServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;xyz.cafe.web.SigninServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;SigninServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/signin&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
            </pre>

            <p>So our new <strong>web.xml</strong> looks like:</p>

            <pre>
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee
                             http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot; version=&quot;3.1&quot;&gt;
    &lt;servlet&gt;
        &lt;servlet-name&gt;CreateServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;xyz.cafe.web.post.CreateServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;CreateServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/create&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;SigninServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;xyz.cafe.web.SigninServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;SigninServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/signin&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;listener&gt;
        &lt;listener-class&gt;
            xyz.cafe.startup.AppStartup
        &lt;/listener-class&gt;
    &lt;/listener&gt;

&lt;/web-app&gt;
            </pre>

            <p>Let's create our signin jsp. Create a new Jsp located at:</p>

            <pre>src/main/webapp/jsp/<strong>signin.jsp</strong></pre>

            <p>Copy &amp; paste the following code into <strong>signin.jsp</strong>:</p>

            <pre>
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Cafe : Signin&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;h1&gt;Signin&lt;/h1&gt;

&lt;c:if test=&quot;${not empty message}&quot;&gt;
    &lt;p&gt;&lt;c:out value=&quot;${message}&quot;/&gt;&lt;/p&gt;
&lt;/c:if&gt;

&lt;form action=&quot;${pageContext.request.contextPath}/auth&quot; method=&quot;post&quot;&gt;

    &lt;label&gt;Username&lt;/label&gt;
    &lt;input type=&quot;text&quot; name=&quot;username&quot; placeholder=&quot;Username&quot;/&gt;

    &lt;br/&gt;

    &lt;label&gt;Password&lt;/label&gt;
    &lt;input type=&quot;text&quot; name=&quot;password&quot; placeholder=&quot;Password ***&quot;/&gt;

    &lt;br/&gt;
    &lt;br/&gt;

    &lt;input type=&quot;submit&quot; value=&quot;Signin&quot;/&gt;
&lt;/form&gt;

&lt;/body&gt;
&lt;/html&gt;
            </pre>

            <p>Great! Let's run it again and browse to <strong>/siginin</strong>
            to see if we can view our signin screen.</p>

            <pre>mvn jetty:run</pre>

            <p>Open up the web browser again and browse to:</p>

            <pre>http://localhost:8080/cafe/signin</pre>

            <p>So you should have failed the Parakeet authentication check and
            been passed a signin.jsp view. It should look something like this:</p>

            <img src="images/signin.png" style="width:100%"/>

            <p>Let's wire it up now. We need to create an authentication routine.
            Our security module will handle most of the heavy lifting, we just now
            need to configure it. Let's start by creating an <strong>AuthServlet</strong>
            at:</p>

            <pre>src/main/java/xyz/cafe/web/<strong>AuthServlet.java</strong></pre>

            <p>Copy &amp; paste the following code into it.</p>

            <pre>
package xyz.cafe.web;

import io.github.mcroteau.Parakeet;
import xyz.cafe.common.Constants;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class AuthServlet extends HttpServlet {

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        ServletContext context = req.getServletContext();
        Parakeet parakeet = (Parakeet) context.getAttribute(Constants.PARAKEET_LOOKUP);

        String username = req.getParameter("username");
        String password = req.getParameter("password");

        if(parakeet.login(username, password)){
            resp.sendRedirect(req.getContextPath() + "/");
        }else{
            req.setAttribute("message", "Username and password are incorrect! Please try again!");
            req.getRequestDispatcher("/jsp/signin.jsp").forward(req, resp);
        }

    }

}
            </pre>

            <p>As you can see, we simply get the instance of parakeet, grab the
            username and password from the request and validate the user. When
            storing a user password, please use
            <strong>io.github.mcroteau.resources.Constants.hash()</strong>
            to hash your password as this is the same hashing algorithm used
            when validating during login.</p>

            <p>Now that we have the authentication piece added including
            the signin.jsp, let's add the logout routine.</p>

            <p>Create a servlet and name it <strong>LogoutServlet.java</strong> : </p>

            <pre>src/main/java/xyz/cafe/<strong>LogoutServlet.java</strong></pre>

            <p>Copy &amp; paste the following code into it</p>

            <pre>
package xyz.cafe.web;

import io.github.mcroteau.Parakeet;
import xyz.cafe.common.Constants;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class LogoutServlet extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        ServletContext context = req.getServletContext();
        Parakeet parakeet = (Parakeet) context.getAttribute(Constants.PARAKEET_LOOKUP);
        parakeet.logout();

        resp.sendRedirect(req.getContextPath() + "/");
    }

}
            </pre>

            <p>Now we have a logout routine. We grabbed Parakeet once again, and simply
            called the logout function.</p>

            <p>With all of this in place, we have no main page yet. We create a
            Dao for posts which will allow us to create, save, list and update
            posts but we have no views. Let's start by creating one view for list
            so when a user browses to the application at:</p>

            <pre>http://localhost:8080/cafe</pre>

            <p>We have something to show them. We are going to show them a list
            of blog posts, that's what should be shown on the base page, that's
            what we will give them, we will also create an edit jsp.</p>

            <p>Create a jsp in the <strong>post</strong> jsp sub directory
                and name it <strong>list.jsp</strong> like so:</p>

            <pre>src/main/webapp/jsp/post/<strong>list.jsp</strong></pre>

            <p>Copy &amp; paste the following code into it: </p>

            <pre>
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;
&lt;%@ taglib prefix=&quot;parakeet&quot; uri=&quot;/META-INF/tags/parakeet.tld&quot;%&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Cafe : Posts&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

    &lt;h1&gt;Latest Posts&lt;/h1&gt;

    &lt;c:if test=&quot;${posts != null || posts.size() &gt; 0}&quot;&gt;
        &lt;div id=&quot;latest-posts&quot;&gt;
            &lt;c:forEach var=&quot;post&quot; items=&quot;${posts}&quot;&gt;
                &lt;div class=&quot;post-container&quot;&gt;
                    &lt;h2&gt;${post.title}&lt;/h2&gt;
                    &lt;span class=&quot;tiny&quot;&gt;${post.date}&lt;/span&gt;
                    &lt;div&gt;${post.content}
                        &lt;a href=&quot;${pageContext.request.contextPath}/edit?id=${post.id}&quot;&gt;Edit&lt;/a&gt;
                    &lt;/div&gt;

                &lt;/div&gt;
            &lt;/c:forEach&gt;

        &lt;/div&gt;
    &lt;/c:if&gt;
    &lt;c:if test=&quot;${posts == null || posts.size() == 0}&quot;&gt;
        &lt;p&gt;No posts created yet.
            &lt;parakeet:isAuthenticated&gt;
                &lt;a href=&quot;${pageContext.request.contextPath}/create&quot;&gt;Create&lt;/a&gt;
            &lt;/parakeet:isAuthenticated&gt;
        &lt;/p&gt;
    &lt;/c:if&gt;
&lt;/body&gt;
&lt;/html&gt;
            </pre>


            <p>What are we doing in this jsp? Well, we are first checking
                to see if there are any posts in the requested attributes,
                if so, iterating through all of them and displaying the post.
            If none exist, and the user is authenticated, show the create button.
            Pretty neat huh? Let's secure our create screen.</p>

            <p>Create a <strong>edit.jsp</strong> Jsp at:</p>

            <pre>src/main/webapp/jsp/post/<strong>edit.jsp</strong></pre>

            <p>Copy &amp; past the following code into that file:</p>

            <pre>
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Cafe : Edit Post&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Edit Post&lt;/h1&gt;

&lt;c:if test=&quot;${not empty message}&quot;&gt;
    &lt;p&gt;&lt;c:out value=&quot;${message}&quot;/&gt;&lt;/p&gt;
&lt;/c:if&gt;

&lt;form action=&quot;${pageContext.request.contextPath}/update&quot; method=&quot;post&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;${post.id}&quot;/&gt;

    &lt;label&gt;Title&lt;/label&gt;
    &lt;input type=&quot;text&quot; name=&quot;title&quot; placeholder=&quot;title&quot; value=&quot;${post.title}&quot;/&gt;

    &lt;br/&gt;

    &lt;label&gt;Content&lt;/label&gt;
    &lt;textarea name=&quot;content&quot;&gt;${post.content}&lt;/textarea&gt;

    &lt;br/&gt;
    &lt;br/&gt;

    &lt;input type=&quot;submit&quot; value=&quot;update&quot;/&gt;
&lt;/form&gt;


&lt;form action=&quot;${pageContext.request.contextPath}/delete&quot; method=&quot;post&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;${post.id}&quot;/&gt;
    &lt;input type=&quot;submit&quot; value=&quot;Delete&quot;/&gt;
&lt;/form&gt;


&lt;/body&gt;
&lt;/html&gt;
            </pre>


            <p>Open up your <strong>CreateServlet.java</strong> again, we
            are going to modify/secure it. Make it look like:</p>

            <pre>
package xyz.cafe.web.post;

import io.github.mcroteau.Parakeet;
import xyz.cafe.common.Constants;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class CreateServlet extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        ServletContext context = req.getServletContext();
        Parakeet parakeet = (Parakeet) context.getAttribute(Constants.PARAKEET_LOOKUP);

        if(parakeet.isAuthenticated()){
            req.getRequestDispatcher("/jsp/post/create.jsp").forward(req, resp);
        }else{
            resp.sendRedirect(context.getContextPath() + "/signin");
        }
    }

}
            </pre>

            <p>Simply secured!</p>

            <p>Let's run it and see if the login functionality works. Again,
            command + c to stop and :</p>

            <pre>mvn jetty:run</pre>

            <p>Browse to <strong>/create</strong></p>

            <pre>http://localhost:8080/cafe/create</pre>

            <p>We should be kicked back to the signin screen.</p>

            <img src="images/signin.png" style="width:100%"/>

            <p>Our Auth Servlet will fail without it being
            declared within the <strong>web.xml</strong>. So, while we
            are at it, we are going to declare all of our serlvets
            within the <strong>web.xml</strong>.</p>

            <p>So let's do that, update the <strong>web.xml</strong>
            to look like:</p>

            <pre>
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee
                             http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot; version=&quot;3.1&quot;&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;ListServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;xyz.cafe.web.post.ListServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ListServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;CreateServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;xyz.cafe.web.post.CreateServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;CreateServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/create&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;SaveServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;xyz.cafe.web.post.SaveServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;SaveServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/save&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;EditServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;xyz.cafe.web.post.EditServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;EditServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/edit&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;UpdateServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;xyz.cafe.web.post.UpdateServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;UpdateServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/update&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;DeleteServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;xyz.cafe.web.post.DeleteServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;DeleteServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/delete&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;


    &lt;servlet&gt;
        &lt;servlet-name&gt;SigninServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;xyz.cafe.web.SigninServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;SigninServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/signin&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;AuthServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;xyz.cafe.web.AuthServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;AuthServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/auth&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;LogoutServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;xyz.cafe.web.LogoutServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;LogoutServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/logout&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;filter&gt;
        &lt;filter-name&gt;Parakeet&lt;/filter-name&gt;
        &lt;filter-class&gt;io.github.mcroteau.resources.filters.CacheFilter&lt;/filter-class&gt;
    &lt;/filter&gt;

    &lt;filter-mapping&gt;
        &lt;filter-name&gt;Parakeet&lt;/filter-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;

    &lt;!--
    &lt;filter&gt;
        &lt;filter-name&gt;sitemesh&lt;/filter-name&gt;
        &lt;filter-class&gt;com.opensymphony.sitemesh.webapp.SiteMeshFilter&lt;/filter-class&gt;
    &lt;/filter&gt;

    &lt;filter-mapping&gt;
        &lt;filter-name&gt;sitemesh&lt;/filter-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;
    --&gt;

    &lt;listener&gt;
        &lt;listener-class&gt;
            xyz.cafe.startup.AppStartup
        &lt;/listener-class&gt;
    &lt;/listener&gt;

&lt;/web-app&gt;
            </pre>


            <p>We are kind of doing it all at once now so let's
            complete our application by creating servlets for,
            editing, updating &amp; deleting posts.</p>

            <p>Let's create our <strong>EditServlet.java</strong></p>

            <pre>src/main/java/xyz/cafe/web/post/<strong>EditServlet.java</strong></pre>

            <p>Copy &amp; paste the following into your new EditServlet</p>

            <pre>
package xyz.cafe.web.post;

import io.github.mcroteau.Parakeet;
import xyz.cafe.dao.PostDao;
import xyz.cafe.model.Post;
import xyz.cafe.common.Constants;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class EditServlet extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        ServletContext context = req.getServletContext();
        Parakeet parakeet = (Parakeet) context.getAttribute(Constants.PARAKEET_LOOKUP);
        PostDao postDao = (PostDao) context.getAttribute(Constants.POSTS_DAO_LOOKUP);

        long id = Long.parseLong(req.getParameter("id"));
        String permission = Constants.POST_PREFIX + id;
        if(parakeet.hasPermission(permission) ||
            parakeet.hasRole(Constants.ROLE_OWNER)){
            Post post = postDao.getById(id);
            req.setAttribute("post", post);
            req.getRequestDispatcher("/jsp/post/edit.jsp").forward(req, resp);
        }else{
            req.getRequestDispatcher("/jsp/unauthorized.jsp").forward(req, resp);
        }
    }
}
            </pre>


            <p>Let's create our <strong>UpdateServlet.java</strong></p>

            <pre>src/main/java/xyz/cafe/web/post/<strong>UpdateServlet.java</strong></pre>

            <p>Copy &amp; paste the following code into it:</p>

            <pre>
package xyz.cafe.web.post;

import io.github.mcroteau.Parakeet;
import xyz.cafe.dao.PostDao;
import xyz.cafe.model.Post;
import xyz.cafe.common.Constants;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class UpdateServlet extends HttpServlet {

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        ServletContext context = req.getServletContext();
        Parakeet parakeet = (Parakeet) context.getAttribute(Constants.PARAKEET_LOOKUP);
        PostDao postDao = (PostDao) context.getAttribute(Constants.POSTS_DAO_LOOKUP);

        long id = Long.parseLong(req.getParameter("id"));
        String permission = Constants.POST_PREFIX + id;
        if(parakeet.hasPermission(permission)){

            Post post = postDao.getById(id);

            String title = req.getParameter("title");
            String content = req.getParameter("content");

            post.setTitle(title);
            post.setContent(content);

            postDao.update(post);
            req.setAttribute("post", post);
            req.getRequestDispatcher("/jsp/post/edit.jsp").forward(req, resp);
        }else{
            req.getRequestDispatcher("/jsp/unauthorized.jsp").forward(req, resp);
        }
    }
}
            </pre>

            <p>Let's create our <strong>DeleteServlet.java</strong></p>
            <pre>src/main/java/xyz/cafe/web/post/<strong>DeleteServlet.java</strong></pre>

            <p>Copy &amp; paste the following code into it:</p>

            <pre>
package xyz.cafe.web.post;

import io.github.mcroteau.Parakeet;
import xyz.cafe.dao.PostDao;
import xyz.cafe.common.Constants;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class DeleteServlet extends HttpServlet {

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        ServletContext context = req.getServletContext();
        Parakeet parakeet = (Parakeet) context.getAttribute(Constants.PARAKEET_LOOKUP);
        PostDao postDao = (PostDao) context.getAttribute(Constants.POSTS_DAO_LOOKUP);

        if(parakeet.isAuthenticated() &&
                parakeet.hasRole(Constants.ROLE_OWNER)){

            long id = Long.parseLong(req.getParameter("id"));
            postDao.delete(id);
            resp.sendRedirect(context.getContextPath() + "/");

        }else{
            req.setAttribute("message", "You don't have privileges to do this...");
            req.getRequestDispatcher("/jsp/unauthorized.jsp").forward(req, resp);
        }
    }
}

            </pre>

            <p>Let's create our <strong>ListServlet.java</strong> that
            retrieves all blog posts and displays them in a list format.</p>

            <pre>src/main/java/xyz/cafe/web/post/<strong>ListServlet.java</strong></pre>

            <p>Copy &amp; paste the following code into it:</p>

            <pre>
package xyz.cafe.web.post;

import io.github.mcroteau.Parakeet;
import xyz.cafe.dao.PostDao;
import xyz.cafe.model.Post;
import xyz.cafe.common.Constants;
import xyz.cafe.common.Utils;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;

public class ListServlet extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        ServletContext context = req.getServletContext();
        Parakeet parakeet = (Parakeet) context.getAttribute(Constants.PARAKEET_LOOKUP);
        PostDao postDao = (PostDao) context.getAttribute(Constants.POSTS_DAO_LOOKUP);

        if(parakeet.isAuthenticated()) {
            List&lt;Post&gt; posts = postDao.getList();
            for (Post post : posts) {
                post.setDate(Utils.getDate(post.getDateCreated()));
            }
            req.setAttribute(&quot;posts&quot;, posts);
        }
        req.getRequestDispatcher(&quot;/jsp/post/list.jsp&quot;).forward(req, resp);
    }
}
            </pre>


            <h1>Okay!</h1>

            <h3>Long overdue</h3>

            <p>Lets see if we can login and create a blog post! Restart
            the application again with command + c, then:</p>

            <pre>mvn jetty:run</pre>

            <p>Browse to:</p>

            <pre>http://localhost:8080/cafe/signin</pre>

            <p>We have 2 possible users we can log in as, one, the
            owner, the other a barista. Again, we do this in our startup routine
            automatically. If you look at <strong>exec/create-db.sql</strong></p>

            <pre>
insert into accounts values (1, 'owner', 'owner@mail.co', '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8');
insert into accounts values (2, 'barista', 'barista@mail.co', '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8');
            </pre>

            <p>Both have <strong>password</strong> as the password, you won't
            be able to tell by looking at the hash of course, but that is what is
            being stored. So let's login as the barista and create a blog post.</p>

            <p>Browsing to:</p>

            <pre>http://localhost:8080/cafe/signin</pre>

            <p>Login as the barista</p>

            <pre>
username: <strong>barista@mail.co</strong>
password: <strong>password</strong>
            </pre>

            <p>After logging in you should see the following screen. </p>

            <img src="images/empty.png" style="width:100%"/>

            <p>Yet, another congratulations! Go, ahead and see if you can create
            one by clicking <strong>create</strong>.</p>

            <p>Give your post a title, and add content... then click
            <strong>save!</strong>. You should now see an edit screen!</p>

            <img src="images/edit.png" style="width:100%"/>

            <p>We have successfully saved a blog post!!! Let's go to the
            main screen and see if we can see our post there as well...
            browse to:</p>

            <pre>http://localhost:8080/cafe</pre>

            <p>You should see something like the following:</p>

            <img src="images/list-uno.png" style="width:100%"/>

            <h3>Yah!</h3>

            <p>We have created a secured blogging application, what's missing though?
            If you look at the Jsps as of now, we have to copy and paste entire
            layouts for each jsp. How do we address this issue? Enter
                <strong>Sitemesh</strong>, a robust layout solution. We use
            Sitemesh 2 instead of 3 as it has proven to work without issue, no need
            to fix something that ain't broke!</p>

            <p>So what do we do. Well, if you look at the <strong>pom.xml</strong>
            we have Sitemesh declared as a dependency. Now we need to configure it.
            Sitemesh comes with a filter that we need to define... .... ... wait
            a minute, it's already defined. It is just commented out in our
            <strong>web.xml</strong>. So let's uncomment it. Look for:</p>

            <pre>
<strong>&lt;!--</strong>
&lt;filter&gt;
    &lt;filter-name&gt;sitemesh&lt;/filter-name&gt;
    &lt;filter-class&gt;com.opensymphony.sitemesh.webapp.SiteMeshFilter&lt;/filter-class&gt;
&lt;/filter&gt;

&lt;filter-mapping&gt;
    &lt;filter-name&gt;sitemesh&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
<strong>--&gt;</strong>
            </pre>

            <p>Delete the surrounding comments so that it
            looks like:</p>

            <pre>
&lt;filter&gt;
    &lt;filter-name&gt;sitemesh&lt;/filter-name&gt;
    &lt;filter-class&gt;com.opensymphony.sitemesh.webapp.SiteMeshFilter&lt;/filter-class&gt;
&lt;/filter&gt;

&lt;filter-mapping&gt;
    &lt;filter-name&gt;sitemesh&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
            </pre>


            <p>Next we need to create a <strong>decorators.xml</strong> file
            that basically tells the application which endpoints to style
                with a layout and what layouts to use. So go ahead and create
            <strong>decorators.xml</strong> at:</p>

            <pre>src/main/webapp/WEB-INF/<strong>decorators.xml</strong></pre>

            <p>Copy &amp; paste the following code into it:</p>

            <pre>
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;decorators defaultdir=&quot;/jsp/layouts&quot;&gt;
    &lt;decorator name=&quot;loggedin&quot; page=&quot;loggedin.jsp&quot;&gt;
        &lt;pattern&gt;*/create&lt;/pattern&gt;
        &lt;pattern&gt;*/save&lt;/pattern&gt;
        &lt;pattern&gt;*/edit&lt;/pattern&gt;
        &lt;pattern&gt;*/update&lt;/pattern&gt;
        &lt;pattern&gt;*/delete&lt;/pattern&gt;
    &lt;/decorator&gt;
    &lt;decorator name=&quot;guest&quot; page=&quot;guest.jsp&quot;&gt;
        &lt;pattern&gt;*/&lt;/pattern&gt;
        &lt;pattern&gt;*/signin&lt;/pattern&gt;
        &lt;pattern&gt;*/logout&lt;/pattern&gt;
    &lt;/decorator&gt;
&lt;/decorators&gt;
            </pre>

            <p>Here we have defined 2 layouts for our application, one
            for users that are authenticated and the other for guest users...
            people that have not logged in.</p>

            <p>Let's create both.</p>

            <p>Start with <strong>guest.jsp</strong> located at: </p>

            <pre>src/main/webapp/jsp/layouts/<strong>guest.jsp</strong></pre>

            <p>Copy &amp; paste the following code in it:</p>

            <pre>
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;%@ taglib uri=&quot;http://www.opensymphony.com/sitemesh/decorator&quot; prefix=&quot;decorator&quot; %&gt;
&lt;%@ taglib prefix=&quot;parakeet&quot; uri=&quot;/META-INF/tags/parakeet.tld&quot;%&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Cafe : Adore it&lt;/title&gt;
    &lt;decorator:head /&gt;
&lt;/head&gt;
&lt;body&gt;

    &lt;parakeet:anonymous&gt;
        &lt;a href=&quot;${pageContext.request.contextPath}/signin&quot;&gt;Signin&lt;/a&gt;
    &lt;/parakeet:anonymous&gt;

    &lt;parakeet:isAuthenticated&gt;
        &lt;parakeet:username/&gt; | &lt;a href=&quot;${pageContext.request.contextPath}/logout&quot;&gt;Logout&lt;/a&gt; |
        &lt;a href=&quot;${pageContext.request.contextPath}/create&quot;&gt;Create&lt;/a&gt;
    &lt;/parakeet:isAuthenticated&gt;

    &lt;decorator:body /&gt;

&lt;/body&gt;
&lt;/html&gt;
            </pre>

            <p>Now let's create the layout for authenticated users. Create
            a Jsp named <strong>loggedin.jsp</strong> at:</p>

            <pre>src/main/webapp/layouts/<strong>loggedin.jsp</strong></pre>

            <p>Copy &amp; paste the following code into it:</p>

            <pre>
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;%@ taglib uri=&quot;http://www.opensymphony.com/sitemesh/decorator&quot; prefix=&quot;decorator&quot; %&gt;
&lt;%@ taglib prefix=&quot;parakeet&quot; uri=&quot;/META-INF/tags/parakeet.tld&quot;%&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Cafe : Welcome back!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;parakeet:anonymous&gt;
        &lt;a href=&quot;${pageContext.request.contextPath}/signin&quot;&gt;Signin&lt;/a&gt;
    &lt;/parakeet:anonymous&gt;

    &lt;parakeet:isAuthenticated&gt;
        &lt;parakeet:username/&gt; |
        &lt;a href=&quot;${pageContext.request.contextPath}/logout&quot;&gt;Logout&lt;/a&gt; |
        &lt;a href=&quot;${pageContext.request.contextPath}/&quot;&gt;Posts&lt;/a&gt;

    &lt;/parakeet:isAuthenticated&gt;

    &lt;decorator:body /&gt;

&lt;/body&gt;
&lt;/html&gt;
            </pre>

            <p>Now, let's restart our application, control + c to stop and :</p>

            <pre>mvn jetty:run</pre>

            <p>Okay, now browse to:</p>

            <pre>http://localhost:8080/cafe</pre>

            <p>You should see something that looks like this:</p>

            <img src="images/posts-layout.png" style="width:100%"/>

            <p>Go ahead! Navigate around... each one of our pages are now
            quote unquote decorated with layouts. When you add a new view or
            otherwise endpoint, to decorate, open up the
            <strong>decorators.xml</strong> file and add your decorator or
            simply the page to decorate under a layout.</p>

            <p>We forgot one thing... what if we reach a page that we
            do not have permission to view? Let's create a view/jsp for this
            and name it <strong>unauthorized.jsp</strong> at:</p>

            <pre>src/main/webapp/jsp/<strong>unauthorized.jsp</strong></pre>

            <p>Copy &amp; paste the following code into it:</p>

            <pre>Unauthorized yo!</pre>

            <p>Simple enough eh?!</p>

            <p>What about styling? Let's try out a new css library called...</p>

            <h3>Millgram</h3>
            <p><a href="www.milligram.io" target="_blank">milligram.io</a></p>

            <p>All we need to do is in our layouts is to add the CDN
            references and maybe a small css style for our body so we have a
            little padding. Copy &amp; paste the following in the
            head tag below the title in both the </p>

            <p>Copy &amp; paste the following in the head sections of both
                <strong>guest.jsp</strong> and <strong>loggedin.jsp</strong>:</p>

            <pre>
&lt;!-- Google Fonts --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic&quot;&gt;

&lt;!-- CSS Reset --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css&quot;&gt;

&lt;!-- Milligram CSS --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css&quot;&gt;

&lt;style type=&quot;text/css&quot;&gt;
    body{
        padding:20px;
    }
&lt;/style&gt;
            </pre>

            <p>Located at: </p>

            <pre>src/main/webapp/jsp/layouts/<strong>guest.jsp</strong></pre>

            <p>&amp;</p>

            <pre>src/main/webapp/jsp/layouts/<strong>loggedin.jsp</strong></pre>


            <h2>Wow!</h2>

            <p>All that styling work is done for us! Thank you Milligram.</p>

            <p>Here is what our final application should look like:</p>

            <img src="images/milligram.png" style="width:100%"/>

            <p>So whats next? Well, how about we Springify it.
            <a href="https://spring.io/">www.spring.io</a>.</p>

            <p><strong>What is Spring?</strong> Spring is a
            dependency injection or inversion of control framework.
            What does this mean? It basically means class dependencies
            can be newed up without you have to write a bunch of newing
            code. Example: Let's look at our EditServlet.</p>

            <pre>
public class EditServlet extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        ServletContext context = req.getServletContext();
        Parakeet parakeet = (Parakeet) context.getAttribute(Constants.PARAKEET_LOOKUP);
        PostDao postDao = (PostDao) context.getAttribute(Constants.POSTS_DAO_LOOKUP);

        long id = Long.parseLong(req.getParameter("id"));
        String permission = Constants.POST_PREFIX + id;
        if(parakeet.hasPermission(permission) ||
            parakeet.hasRole(Constants.ROLE_OWNER)){
            Post post = postDao.getById(id);
            req.setAttribute("post", post);
            req.getRequestDispatcher("/jsp/post/edit.jsp").forward(req, resp);
        }else{
            req.getRequestDispatcher("/jsp/unauthorized.jsp").forward(req, resp);
        }
    }
}
            </pre>

            <p>With Spring we can declare what are called Spring Beans within
            a configuration pattern either programmatically or via xml config.
            Here is what the same class would look like.</p>

            <pre>
public class EditServlet extends HttpServlet {

    @Autowired
    private PostDao postDao;

    @Autowired
    private Parakeet parakeet;

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        long id = Long.parseLong(req.getParameter("id"));
        String permission = Constants.POST_PREFIX + id;
        if(parakeet.hasPermission(permission) ||
            parakeet.hasRole(Constants.ROLE_OWNER)){
            Post post = postDao.getById(id);
            req.setAttribute("post", post);
            req.getRequestDispatcher("/jsp/post/edit.jsp").forward(req, resp);
        }else{
            req.getRequestDispatcher("/jsp/unauthorized.jsp").forward(req, resp);
        }
    }
}
            </pre>

            <p>We have reduced the number of lines of code with in the doGet
            method and now our PostDao and Parakeet instances are automatically
            instantiated. Using SpringMVC, you can cut down the number of
            Servlets tremendously. With SpringJdbc you can cut down the number
            of lines of code as well.</p>

            <p>If you feel like doing this... Spring is great! Im sure you as a
                programmer have already heard about it. Here is a link to a
            Spring version.</p>


            <p>You have to learn how to walk before you can run!</p>


            <p class="center space-it">&copy; OpenCafe</p>


		</div>

		<div class="col-md-3">&nbsp;</div>

		</div>
	</body>
</html>













































